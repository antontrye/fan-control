#!/bin/bash
source /etc/ipmi.conf

if [ $# -ne 1 ]; then
    echo "Usage: $0 <fan_speed>"
    echo "Fan speed must be between 22 and 87"
    exit 1
fi

SPEED=$1

if ! [[ "$SPEED" =~ ^[0-9]+$ ]]; then
    echo "Error: Fan speed must be a number"
    exit 1
fi

if [ "$SPEED" -lt 22 ] || [ "$SPEED" -gt 87 ]; then
    echo "Error: Fan speed must be between 22 and 87"
    exit 1
fi

HEX_SPEED=$(printf '0x%02x' "$SPEED")

timeout 10 ipmitool -I lanplus -y "$IPMI_KEY" -H "$IPMI_HOST" -U "$IPMI_USER" -P "$IPMI_PASS" raw 0x30 0x30 0x01 0x00
timeout 10 ipmitool -I lanplus -y "$IPMI_KEY" -H "$IPMI_HOST" -U "$IPMI_USER" -P "$IPMI_PASS" raw 0x30 0x30 0x02 0xff "$HEX_SPEED"

echo "Fan speed set to $SPEED ($HEX_SPEED)"